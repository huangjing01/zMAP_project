{% extends 'base.html' %} 
{% block title %}
    zMAP
{% endblock %}
{% block content %}
<div class="container" style="width: 98%;">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div class="row">
        <div class="col-md-6">
          <br /><br />
    <h1 style="display: block; text-align: center; font-size: 24px; letter-spacing: 0.18rem; margin-top: 0px; margin-bottom: 0px;">zMAP module</h1>
          <img src="{{ url_for('lib.static', filename='img/zMAP_workflow.png') }}" class="img-fluid" style="max-width: 60%; height: auto;margin-right: auto;">
        </div>
        <div class="col-md-6">
          <br />
          <br />
    <br />
    <br />
  <h2 style="display: block; margin-left: auto; margin-right: auto; font-size: 20px; letter-spacing: 0.18rem; margin-top: 0px; margin-bottom: 0px;">Functional Description:</h2>
          <p>The design of zMAP aims to simultaneously compare protein profiles of multiple samples and integrate samples from different MS runs for identifying hypervariable proteins across samples. zMAP models the mean-variance dependence associated with ILMS intensities and accordingly applies a variance-stabilizing z-transformation(z-statistic), which dramatically increases the comparability between samples generated by different MS runs. The z-statistic can be widely applied in downstream analyses, including PCA, clustering analysis, GSVA, and so on. To facilitate biologists' usage, we offer a user-friendly and straightforward web service. zMAP requires that all the involved MS runs are associated with the same biological design, such that the average intensities across all samples in each run are biologically identical.<br>
            A test example is:<br>
            Protein intensity file(tab-delimited): <a href="{{url_for('manual.example_data',example_file='zMAP_example_protein_intensity.txt')}}">zMAP_example_protein_intensity.txt</a><br>
            Sample information file(tab-delimited): <a href="{{url_for('manual.example_data',example_file='zMAP_example_sample_info.txt')}}">zMAP_example_sample_info.txt</a><br>
          </p>
          <div>
          {% with messages = get_flashed_messages() %}
            {% if messages %}
            <p class="file-error-message" style="display: block;">
              {{ messages[0] }}
            </p> 
            {% endif %}
          {% endwith %}
          <div id="upload_form1">
            <form action="{{url_for('zMap.index')}}" class="form-group" role="form" method="post" id="formID" enctype="multipart/form-data">
              <div class="control-group" style="margin-bottom: 24px">
                <label for="input-1" class="control-label">
                  <b>Protein intensity file</b>
                </label>
                <input id="input-1" name="input-1" type="file" accept=".txt" data-show-preview="false" class="file-loading" />
                <p id="errorBlock1"></p>
              </div>
              <div class="control-group" style="margin-bottom: 24px">
                <label for="input-2" class="control-label">
                  <b>Sample information file</b>
                </label>
                <input id="input-2" name="input-2" type="file" accept=".txt" data-show-preview="false" class="file-loading" />
                <p id="errorBlock2"></p>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="control-group" style="margin-bottom: 24px"> 
                  <label class="control-label"><b>Window size</b></label> 
                  <div class="controls "> 
                  <input type="number" class="form-control" required="" min="100" max="1000" name="window_size" value="400" /> 
                  </div> 
                  </div> 
                </div>
                <div class="col-md-4">
                  <div class="control-group" style="margin-bottom: 24px"> 
                  <label class="control-label"><b>Step size</b></label> 
                  <div class="controls "> 
                  <input type="number" class="form-control" required="" min="80" name="step_size" value="100" /> 
                  </div> 
                  </div> 
                </div>

                <div class="col-md-4">
                  <div class="control-group" style="margin-bottom: 24px"> 
                  <label class="control-label"><b>Proportion of proteins used for linear regression(%)</b></label>
                  <div class="controls "> 
                  <input type="number" class="form-control" required="" min="30" max="50" name="percent" value="30" /> 
                  </div> 
                  </div> 
                </div>
              </div>
              <div class="control-group" style="margin-bottom: 24px">
                <label class="control-label">
                  <b>MVC fitting method</b>
                </label>
                <select class="form-control" style="margin-bottom: 24px" name="method">
                  <option value="exponential_function">exponential model</option>
                  <option value="natural_cubic_spline">natural cubic spline model</option>
                </select>
              </div>
              <div class="control-group" style="margin-bottom: 24px">
                <label class="control-label">
                  <b>Email address<i>(optional)</i>
                  </b>
                </label>
                <div class="controls control-label">
                  <input type="email" class="form-control" name="email" data-validation-email-message="Invalid email" />
                </div>
              </div>
              <button type="reset" class="btn btn-primary" style="background-color: #CA8115;height: 45px;width: 80px;float: left;margin-left: 50px">Reset</button>
              <button type="submit" class="btn btn-primary" style="background-color: #27357e;height: 45px;width: 80px;float: right;margin-right: 20px" onclick="alert('please upload a valid file.')">Submit</button>
            </form>
            <br />
            <br />
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>
function free(){
   $("#formID").attr("action","{{url_for('zMap.index')}}");
};
var variable1;
var variable2;
var file1Uploaded = false;
var file2Uploaded = false;
function checkAllFilesUploaded() {
    if (file1Uploaded && file2Uploaded) {
      
       $("button[type=reset]").prop('disabled',false);
       $("button[type=submit]").prop('disabled',false);
       $("button[type=submit]").removeAttr("onclick");
       $("button[type=reset]").attr("onclick","free();");
       $("#formID").attr("action","{{ url_for('zMap.zMap_processing', process_id1='ADDSHARE2',process_id2='ADDSHARE3') }}".replace("ADDSHARE2", variable1).replace("ADDSHARE3", variable2));
    }
};

$(document).on('ready', function() {
    $("#input-1").fileinput({
        showUpload:false,
        showRemove:false,
        showClose:false,
        uploadUrl:"{{url_for('zMap.validate',input_type='protein_intensity') }}",
        elErrorContainer: "#errorBlock1",
        layoutTemplates: {progress: '<div class="progress-bar progress-bar-striped text-center" aria-valuemax="100" style="width:{percent}%; border-radius:4px;">\n' +
    '        {status}\n' +
    '     </div>\n' }
    }).on("filebatchselected",function(event,files){
            $(this).fileinput("upload");
            $("button[type=reset]").prop('disabled',true);
            $("button[type=submit]").prop('disabled',true);
    }).on("fileuploaded",function(event,data){
            if(data.response){
                if(data.response.id){
                  variable1 = data.response.id;
                  file1Uploaded = true;                  
                  checkAllFilesUploaded();
                }
               
            }
        });

    $("#input-2").fileinput({
        showUpload:false,
        showRemove:false,
        showClose:false,
        uploadUrl:"{{url_for('zMap.validate',input_type='sample_info',process_id='empty') }}",
        elErrorContainer: "#errorBlock2",
        layoutTemplates: {progress: '<div class="progress-bar progress-bar-striped text-center" aria-valuemax="100" style="width:{percent}%; border-radius:4px;">\n' +
    '        {status}\n' +
    '     </div>\n' }


    }).on("filebatchselected",function(event,files){
            $(this).fileinput("upload");
            $("button[type=reset]").prop('disabled',true);
            $("button[type=submit]").prop('disabled',true);

    }).on("fileuploaded",function(event,data){
            if(data.response){
                if(data.response.id){
                  variable2 = data.response.id;
                  file2Uploaded = true;
                  checkAllFilesUploaded();
                }
               
            }
        });


      $("input").not("[type=submit]").jqBootstrapValidation();
 
           

});



</script>  
{% endblock%} 
